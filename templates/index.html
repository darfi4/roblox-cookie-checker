<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roblox Cookie Checker Pro</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div id="particles-js"></div>
    <div class="gradient-bg"></div>
    
    <nav class="navbar">
        <div class="nav-content">
            <div class="logo">
                <i class="fas fa-shield-alt"></i> RCC Pro
            </div>
        </div>
    </nav>

    <div class="container">
        <section class="hero fade-in">
            <h1 class="hero-title">Roblox Cookie Checker Pro</h1>
            <p class="hero-subtitle">Проверка и сортировка Roblox куки</p>
        </section>

        <div class="card">
            <h2 class="card-title"><i class="fas fa-search"></i> Проверка куки</h2>
            
            <div class="form-group">
                <label class="form-label">Введите куки .ROBLOSECURITY (по одной на строку):</label>
                <textarea class="form-input textarea" id="cookiesInput" placeholder="_|WARNING:-DO-NOT-SHARE-THIS.--Sharing-this-will-allow-someone-to-log-in-to-your-account-and-to-steal-your-ROBUX-and-items.|_
_|WARNING:-DO-NOT-SHARE-THIS.--Sharing-this-will-allow-someone-to-log-in-to-your-account-and-to-steal-your-ROBUX-and-items.|_"></textarea>
                <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 0.5rem;">
                    Максимум: 100 куки за одну проверку
                </div>
            </div>
            
            <button class="btn" onclick="checkCookies()" id="checkButton">
                <i class="fas fa-search"></i> Проверить куки
            </button>
            <button class="btn btn-danger" onclick="clearInput()" style="margin-left: 1rem;">
                <i class="fas fa-trash"></i> Очистить
            </button>
        </div>

        <div id="results"></div>
    </div>

    <!-- Модальное окно для скачивания -->
    <div id="downloadModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3><i class="fas fa-download"></i> Скачать результаты</h3>
            <p>Хотите скачать архив с проверенными куки, отсортированными по категориям?</p>
            <div class="modal-actions">
                <button class="btn btn-success" onclick="downloadArchive()">
                    <i class="fas fa-download"></i> Скачать архив
                </button>
                <button class="btn btn-danger" onclick="closeModal()">
                    <i class="fas fa-times"></i> Отказаться
                </button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/particles.js') }}"></script>
    <script>
        let currentSessionId = null;

        async function checkCookies() {
            const input = document.getElementById('cookiesInput').value;
            const resultsDiv = document.getElementById('results');
            const button = document.getElementById('checkButton');
            
            if (!input.trim()) {
                showNotification('Пожалуйста, введите куки для проверки', 'error');
                return;
            }
            
            button.disabled = true;
            button.innerHTML = '<div class="loading"></div> Проверяем...';
            
            try {
                const cookies = input.split('\n').filter(c => c.trim());
                const response = await fetch('/check', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ cookies: cookies })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displayResults(data);
                    currentSessionId = data.session_id;
                    // Показываем модальное окно через 2 секунды
                    setTimeout(() => {
                        showDownloadModal();
                    }, 2000);
                } else {
                    throw new Error(data.error || 'Ошибка сервера');
                }
                
            } catch (error) {
                showNotification('Ошибка при проверке куки: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-search"></i> Проверить куки';
            }
        }

        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            let html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value stat-total">${data.total}</div>
                        <div>Всего проверено</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value stat-valid">${data.valid}</div>
                        <div>Валидных</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value stat-invalid">${data.invalid}</div>
                        <div>Невалидных</div>
                    </div>
                </div>
            `;
            
            // Показываем только первую валидную и первую невалидную куку для примера
            const validExample = data.results.find(r => r.valid);
            const invalidExample = data.results.find(r => !r.valid);
            
            if (validExample) {
                html += `
                    <div class="card fade-in">
                        <h3 style="color: var(--secondary);"><i class="fas fa-check-circle"></i> Пример валидной куки</h3>
                        <p><strong>Имя:</strong> ${validExample.account_info.name || 'N/A'}</p>
                        <p><strong>ID:</strong> ${validExample.account_info.id || 'N/A'}</p>
                        <p><strong>Robux:</strong> ${validExample.robux_balance.toLocaleString()}</p>
                        <p><strong>Premium:</strong> ${validExample.is_premium ? '✅ Да' : '❌ Нет'}</p>
                    </div>
                `;
            }
            
            if (invalidExample) {
                html += `
                    <div class="card fade-in">
                        <h3 style="color: var(--danger);"><i class="fas fa-times-circle"></i> Пример невалидной куки</h3>
                        <p><strong>Ошибка:</strong> ${invalidExample.error}</p>
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
        }

        function showDownloadModal() {
            document.getElementById('downloadModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('downloadModal').style.display = 'none';
            showNotification('Вы отказались от скачивания', 'info');
        }

        function downloadArchive() {
            if (!currentSessionId) {
                showNotification('Нет данных для скачивания', 'error');
                return;
            }
            
            window.open(`/download/${currentSessionId}`, '_blank');
            document.getElementById('downloadModal').style.display = 'none';
            showNotification('Архив скачивается...', 'success');
        }

        function clearInput() {
            document.getElementById('cookiesInput').value = '';
            document.getElementById('results').innerHTML = '';
            currentSessionId = null;
            showNotification('Поле очищено', 'info');
        }

        function showNotification(message, type = 'info') {
            // Простая реализация уведомлений
            alert(`${type.toUpperCase()}: ${message}`);
        }

        // Закрытие модального окна по клику вне его
        window.onclick = function(event) {
            const modal = document.getElementById('downloadModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>

    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--glass);
            backdrop-filter: blur(20px);
            padding: 2rem;
            border-radius: 15px;
            border: 1px solid var(--glass-border);
            max-width: 400px;
            text-align: center;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
        }
    </style>
</body>
</html>